# have to use node16 before prisma fixes https://github.com/prisma/prisma/issues/10649
FROM node:16-bullseye-slim

RUN npm i -g publicaddr && which publicaddr

# uid=1000 gid=1000
USER node

COPY --chown=node:node . /opt/voxscape

RUN \
    --mount=type=cache,target=/home/node/.yarn,sharing=locked,uid=1000,gid=1000 \
    --mount=type=cache,target=/home/node/.cache,sharing=locked,uid=1000,gid=1000 \
    --mount=type=cache,target=/opt/voxscape/.yarn/cache,sharing=locked,uid=1000,gid=1000 \
    --mount=type=cache,target=/opt/voxscape/web/.next/cache,sharing=locked,uid=1000,gid=1000 \
    set -uex && \
    cd /opt/voxscape/web && \
    yarn --version && \
    yarn config get cacheFolder && \
    yarn && \
    yarn prisma generate && \
    yarn build && \
    yarn workspaces focus --production

# RUN \
    # set -uex && \
    # find /opt/voxscape/web/.next/cache && \
    # cd /opt/voxscape/web && yarn build
