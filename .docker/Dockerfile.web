# have to use node16 before prisma fixes https://github.com/prisma/prisma/issues/10649
FROM node:16-bullseye-slim

RUN npm i -g publicaddr && which publicaddr

# uid=1000 gid=1000
USER node

COPY . /opt/voxscape

RUN \
    --mount=type=cache,target=/home/node/.yarn,sharing=locked,uid=1000,gid=1000 \
    --mount=type=cache,target=/home/node/.cache,sharing=locked,uid=1000,gid=1000 \
    set -uex && \
    cd /opt/voxscape/web && yarn --version && yarn && yarn prisma generate && yarn build

RUN \
    --mount=type=cache,target=/home/node/.yarn,sharing=locked,uid=1000,gid=1000 \
    set -uex && \
    cd /opt/voxscape/web && yarn build
